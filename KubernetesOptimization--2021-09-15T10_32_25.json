{"title":"Kubernetes Optimization","description":"datadog_demo_keep:true","widgets":[{"id":3034624791688390,"definition":{"type":"note","content":"The goal of this dashboard is to understand:\n1. If some deployments are being over-provisioned, so wasting resources.\n2. If some deployments are close to the limit, so may having performance issue\n3. If some of our cluster are having capacity issue or under-utilised. ","background_color":"yellow","font_size":"14","text_align":"left","vertical_align":"center","show_tick":false,"tick_pos":"50%","tick_edge":"left","has_padding":true},"layout":{"x":0,"y":0,"width":12,"height":3}},{"id":7016136663218288,"definition":{"title":"2. Capacity Usage vs Limit. Are we having performance issue?","type":"group","background_color":"vivid_orange","show_title":true,"layout_type":"ordered","widgets":[{"id":4920169306302960,"definition":{"type":"note","content":"**% Usage vs Limit**\nIf red, investigate for which deployment limit should be increased.","background_color":"orange","font_size":"14","text_align":"left","show_tick":true,"tick_pos":"50%","tick_edge":"bottom"},"layout":{"x":0,"y":0,"width":12,"height":1}},{"id":1333127957143082,"definition":{"title":"CPU","title_size":"16","title_align":"left","type":"query_value","requests":[{"formulas":[{"formula":"((query1 / 1000000000) / query2) * 100"}],"conditional_formats":[{"comparator":">","palette":"white_on_red","value":85},{"comparator":"<=","palette":"white_on_green","value":60},{"comparator":"<","palette":"white_on_yellow","value":85}],"response_format":"scalar","queries":[{"query":"sum:kubernetes.cpu.usage.total{*,*,*,$namespace}","data_source":"metrics","name":"query1","aggregator":"avg"},{"query":"sum:kubernetes.cpu.limits{*,*,*,$namespace}","data_source":"metrics","name":"query2","aggregator":"avg"}]}],"custom_unit":"%","precision":2},"layout":{"x":0,"y":1,"width":6,"height":3}},{"id":8110071283634276,"definition":{"title":"Memory","title_size":"16","title_align":"left","type":"query_value","requests":[{"q":"(sum:kubernetes.memory.usage{*,*,*,$namespace}/sum:kubernetes.memory.limits{*,*,*,$namespace})*100","aggregator":"avg","conditional_formats":[{"comparator":">","palette":"white_on_red","value":85},{"comparator":"<","palette":"white_on_green","value":85}]}],"custom_unit":"%","precision":2},"layout":{"x":6,"y":1,"width":6,"height":3}},{"id":3284482967709268,"definition":{"title":"% CPU Usage vs Limit","title_size":"16","title_align":"left","type":"toplist","requests":[{"q":"top(((avg:kubernetes.cpu.usage.total{*,*,*,$namespace} by {kube_deployment}/1000000000)/avg:kubernetes.cpu.limits{*,*,*,$namespace} by {kube_deployment})*100,10,'mean','desc')","conditional_formats":[{"comparator":">=","palette":"white_on_red","value":85},{"comparator":"<","palette":"white_on_green","value":60},{"comparator":"<","palette":"white_on_yellow","value":85}]}]},"layout":{"x":0,"y":4,"width":6,"height":7}},{"id":6339352153655824,"definition":{"title":"% Memory vs Limit","title_size":"16","title_align":"left","type":"toplist","requests":[{"q":"top((avg:kubernetes.memory.usage{*,*,*,$namespace} by {kube_deployment}/avg:kubernetes.memory.limits{*,*,*,$namespace} by {kube_deployment})*100,10,'mean','desc')","conditional_formats":[{"comparator":">","palette":"white_on_red","value":85},{"comparator":"<","palette":"white_on_green","value":85}]}]},"layout":{"x":6,"y":4,"width":6,"height":7}}]},"layout":{"x":0,"y":3,"width":12,"height":12}},{"id":3333471320721142,"definition":{"title":"1. Capacity Usage vs Request. Are teams requesting more than needed?","type":"group","background_color":"vivid_purple","show_title":true,"layout_type":"ordered","widgets":[{"id":436516332017672,"definition":{"type":"note","content":"**% Usage vs Request**\nIf red, investigate which deployments are being over provisioned.","background_color":"purple","font_size":"14","text_align":"left","show_tick":true,"tick_pos":"50%","tick_edge":"bottom"},"layout":{"x":0,"y":0,"width":12,"height":1}},{"id":679675888391910,"definition":{"title":"CPU","title_size":"16","title_align":"left","type":"query_value","requests":[{"formulas":[{"formula":"((query1 / 1000000000) / query2) * 100"}],"conditional_formats":[{"comparator":"<","palette":"white_on_red","value":80},{"comparator":">","palette":"white_on_red","value":120},{"comparator":"<","palette":"white_on_green","value":120},{"comparator":">","palette":"white_on_green","value":80}],"response_format":"scalar","queries":[{"query":"sum:kubernetes.cpu.usage.total{*,*,*,$cluster,$namespace}","data_source":"metrics","name":"query1","aggregator":"avg"},{"query":"sum:kubernetes.cpu.requests{*,*,*,$cluster,$namespace}","data_source":"metrics","name":"query2","aggregator":"avg"}]}],"custom_unit":"%","precision":2},"layout":{"x":0,"y":1,"width":6,"height":3}},{"id":5716152516229788,"definition":{"title":"Memory","title_size":"16","title_align":"left","type":"query_value","requests":[{"q":"(sum:kubernetes.memory.usage{*,*,*,$cluster,$namespace}/sum:kubernetes.memory.requests{*,*,*,$cluster,$namespace})*100","aggregator":"avg","conditional_formats":[{"comparator":"<","palette":"white_on_red","value":60},{"comparator":">","palette":"white_on_green","value":60}]}],"custom_unit":"%","precision":2},"layout":{"x":6,"y":1,"width":6,"height":3}},{"id":2062974234082548,"definition":{"title":"Top CPU over provisioned deployments (Avg of cores requested minus actual usage)","title_size":"16","title_align":"left","type":"toplist","requests":[{"formulas":[{"formula":"query1 - query2 / 1000000000","limit":{"count":50,"order":"desc"}}],"conditional_formats":[{"comparator":">","palette":"white_on_red","value":0},{"comparator":"<","palette":"white_on_green","value":0}],"response_format":"scalar","queries":[{"query":"avg:kubernetes.cpu.requests{*,*,*,$cluster,$namespace} by {pod_name}","data_source":"metrics","name":"query1","aggregator":"avg"},{"query":"avg:kubernetes.cpu.usage.total{*,*,*,$cluster,$namespace} by {pod_name}","data_source":"metrics","name":"query2","aggregator":"avg"}]}]},"layout":{"x":0,"y":4,"width":6,"height":7}},{"id":5628857415160894,"definition":{"title":"Top Memory over provisioned deployments (Avg of memory requested minus actual usage)","title_size":"16","title_align":"left","type":"toplist","requests":[{"formulas":[{"formula":"query1 - query2","limit":{"count":100,"order":"desc"}}],"conditional_formats":[{"comparator":">","palette":"white_on_red","value":0},{"comparator":"<","palette":"white_on_green","value":0}],"response_format":"scalar","queries":[{"query":"avg:kubernetes.memory.requests{$cluster,$namespace} by {pod_name}","data_source":"metrics","name":"query1","aggregator":"avg"},{"query":"avg:kubernetes.memory.usage{$cluster,$namespace} by {pod_name}","data_source":"metrics","name":"query2","aggregator":"avg"}]}]},"layout":{"x":6,"y":4,"width":6,"height":7}}]},"layout":{"x":0,"y":0,"width":12,"height":12,"is_column_break":true}},{"id":4816033202701736,"definition":{"title":"3. Usage vs Total","type":"group","background_color":"vivid_green","show_title":true,"layout_type":"ordered","widgets":[{"id":4214061214539416,"definition":{"type":"note","content":"**% Usage vs Total**\nIf red, investigate which cluster is having issues and increase capacity.","background_color":"green","font_size":"14","text_align":"left","show_tick":true,"tick_pos":"50%","tick_edge":"bottom"},"layout":{"x":0,"y":0,"width":12,"height":1}},{"id":195702899003764,"definition":{"title":"CPU","title_size":"16","title_align":"left","type":"query_value","requests":[{"formulas":[{"formula":"((query1 / 1000000000) / query2) * 100"}],"conditional_formats":[{"comparator":">","palette":"white_on_red","value":85},{"comparator":"<=","palette":"white_on_green","value":60},{"comparator":"<","palette":"white_on_yellow","value":85}],"response_format":"scalar","queries":[{"query":"sum:kubernetes.cpu.usage.total{$namespace,*,*}","data_source":"metrics","name":"query1","aggregator":"sum"},{"query":"sum:kubernetes_state.node.cpu_capacity{*}","data_source":"metrics","name":"query2","aggregator":"sum"}]}],"custom_unit":"%","precision":2},"layout":{"x":0,"y":1,"width":6,"height":3}},{"id":2688034437838798,"definition":{"title":"Memory","title_size":"16","title_align":"left","type":"query_value","requests":[{"formulas":[{"formula":"(query1 / query2) * 100"}],"conditional_formats":[{"comparator":">","palette":"white_on_red","value":85},{"comparator":"<","palette":"white_on_green","value":85}],"response_format":"scalar","queries":[{"query":"sum:kubernetes.memory.usage{$namespace,*,*}","data_source":"metrics","name":"query1","aggregator":"sum"},{"query":"sum:kubernetes_state.node.memory_capacity{$namespace,*,*}","data_source":"metrics","name":"query2","aggregator":"sum"}]}],"custom_unit":"%","precision":2},"layout":{"x":6,"y":1,"width":6,"height":3}},{"id":5975417441604006,"definition":{"title":"Top clusters per %CPU","title_size":"16","title_align":"left","type":"toplist","requests":[{"formulas":[{"formula":"((query1 / 1000000000) / query2) * 100","limit":{"count":10,"order":"desc"}}],"conditional_formats":[{"comparator":">","palette":"white_on_red","value":85},{"comparator":"<=","palette":"white_on_green","value":60},{"comparator":"<","palette":"white_on_yellow","value":85}],"response_format":"scalar","queries":[{"query":"sum:kubernetes.cpu.usage.total{*} by {cluster_name}","data_source":"metrics","name":"query1","aggregator":"sum"},{"query":"sum:kubernetes_state.node.cpu_capacity{*} by {cluster_name}","data_source":"metrics","name":"query2","aggregator":"sum"}]}]},"layout":{"x":0,"y":4,"width":6,"height":2}},{"id":8571550637100326,"definition":{"title":"Top clusters per %Memory","title_size":"16","title_align":"left","type":"toplist","requests":[{"formulas":[{"formula":"(query1 / query2) * 100","limit":{"count":10,"order":"desc"}}],"conditional_formats":[{"comparator":">","palette":"white_on_red","value":85},{"comparator":"<","palette":"white_on_green","value":85}],"response_format":"scalar","queries":[{"query":"sum:kubernetes.memory.usage{$namespace,*,*} by {cluster_name}","data_source":"metrics","name":"query1","aggregator":"sum"},{"query":"sum:kubernetes_state.node.memory_capacity{$namespace,*,*} by {cluster_name}","data_source":"metrics","name":"query2","aggregator":"sum"}]}]},"layout":{"x":6,"y":4,"width":6,"height":2}}]},"layout":{"x":0,"y":12,"width":12,"height":7}}],"template_variables":[{"name":"cluster","default":"jaimealonso-webinar","prefix":"kube_cluster_name"},{"name":"namespace","default":"*","prefix":"kube_namespace"}],"layout_type":"ordered","is_read_only":false,"notify_list":[],"reflow_type":"fixed","id":"wc6-v25-d7u"}